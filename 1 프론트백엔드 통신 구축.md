
## 주식 통계분석을 위한 엑셀 add-in 개발

목적: 엑셀에 주식 종목의 이름, 매매한 날짜, 수익률 등의 데이터가 적혀있고 이를 가지고 쉽게 통계를 내고 분석하기 위함. 
엑셀에 있는 종목의 데이터는 DB에 저장되어있음. 
엑셀웹에서 종목에 대한 정보를 요청하면 프론트에서 백엔드로 HTTP요청을 보내고 백엔드에서 DB로부터 그에 해당하는 데이터를 가져와 전처리 후 다시 프론트로 보내고 프론트에서 시각화하여 엑셀웹에 보여줌.

![[Pasted image 20250528101049.png]]
MY OFFICE ADD-IN 이라는 프로젝트 폴더에 먼저 git으로 관리를 시작해주고 첫번째 커밋을 남겼다.

![[Pasted image 20250528101227.png]]
주로 작업할 공간은 src 폴더의 taskpane, fapi, dialog 이다. 
taskpane, dialog는 프론트엔드로 HTML, CSS, Javascript로 진행하고 백엔드는 FastAPI 로 할 생각이다. 

### uv
uv는 파이썬 패키지 관리 도구이다. 최근 기술으로 보인다.
일단 패키지 설치 속도가 매우 빠르고 최근 기술을 사용해보고 싶어서 사용해보기로 했다. 
fapi라는 프로젝트를 생성했다.


### taskpane.js

```javascript
export async function run() {

  try {

    await Excel.run(async (context) => {

      /**

       * Insert your Excel code here

       */

      const range = context.workbook.getSelectedRange();

  

      // Read the range address

      range.load(["address", "values"]);

  

      await context.sync();

      const stockName = range.values //백엔드로 보낼 데이터(json변환 전)

      console.log(`선택된 범위의 주소: ${range.address}, 값: ${stockName}`);

  

      //////////////////////////////////////////////////////////////////////

      // 2. 백엔드 통신 함수 호출 (Excel.run 외부)

      const chartData = await fetchDataFromBackend(stockName)

      // 3. 차트 렌더링 함수 호출 (Excel.run 외부)

      // await renderChartInNewWindow(chartData);

      //////////////////////////////////////////////////////////////////////

    });

  

  } catch (error) {

    console.error(`fucking error: ${error}`);

  }

}

```

먼저 프론트-백엔드 와의 통신을 구현해 보기로 했다. 
엑셀에서 특정 셀을 선택한후 add-in의 run버튼을 클릭하면 셀안의 value가 백엔드로 넘어가서 그 데이터를 가지고 백엔드에서 작업을 할 수 있게 해야한다.

```javascript
const range = context.workbook.getSelectedRange();

range.load(["address", "values"]);
```
이 코드를 통해 셀의 value와 address 속성에 접근할 수 있다. 
중요한점은 위 코드들은 하나의 배치에 담겨 엑셀 웹앱으로 넘어가게 되고 실제로 객체가 생성되어 내가 조작할 수 있게 되는 시점은 
```javascript
await context.sync();
```
위 코드가 실행되어 promise객체의 반환이 끝나는 시점이다. 이는 엑셀앱과의 통신이 끝나고 내가 실제로 range.values등과 같은 객체를 사용할수 있게되는 시점이다. 
따라서 백엔드 통신함수, 차트생성 함수등은 이 코드 밑에 두어야한다.

#### range.values

![[Pasted image 20250528103203.png]]
![[Pasted image 20250528103210.png]]
다음과 같이 셀을 선택하고 run을 누르면 range.values에 값이 할당될텐데 이 데이터가 백엔드로 가는것이기에 어떤 type인지 어떻게 생겼는지 알아야한다. 
디버거중단점을 활용해서 확인해보면
![[Pasted image 20250528103319.png]]
다음과 같은 2차원 array이다.

2차원 array를 1차원으로 바꾸는 평탄화는 백엔드에서 진행하기로 했다. 


#### 백엔드 통신함수

```javascript
// 4. 백엔드 통신을 담당하는 별도의 함수

async function fetchDataFromBackend(value) {

  const backendUrl = "http://localhost:8000/get_chart_data"; // FastAPI 엔드포인트 주소

  

  try {

    const response = await fetch(backendUrl, {

      method: "POST",

      headers: {

        "Content-Type": "application/json", // JSON 형식으로 데이터 전송

      },

      body: JSON.stringify({ value: value }), // 엑셀에서 가져온 값을 JSON 형태로 변환하여 전송

    });

  

    if (!response.ok) {

      // HTTP 상태 코드가 200-299 범위가 아닐 경우 오류 처리

      const errorText = await response.text();

      throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);

    }

  

    const data = await response.json(); // 백엔드로부터 받은 JSON 응답 파싱

    console.log("백엔드로부터 받은 데이터:", data);

    return data.chart_data; // 차트 데이터를 반환

  } catch (error) {

    console.error("백엔드 통신 오류:", error);

    // 오류 발생 시 기본 데이터 또는 빈 데이터 반환

    return { labels: [], values: [] };

  }

}
```

method로는 GET, POST등이 있는데 POST를 사용한다.
백엔드로 보낼 데이터양이 많아질수 있고 2차원 array같은 복잡한 쿼리는 get요청으로는 부적합할 것이다.

![[Pasted image 20250528103930.png]]
이런 형태의 json 데이터가 백엔드로 넘어간다.

### main.py

```python
from fastapi import FastAPI, HTTPException

from fastapi.middleware.cors import CORSMiddleware

from pydantic import BaseModel

from typing import List, Dict, Any

import pandas as pd

import pymysql # Ensure this is installed via uv

import uvicorn # Added for running the app

  
  

app = FastAPI()

  

# CORS 설정

origins = [

    "https://localhost:3000",  # Office Add-in 프론트엔드 주소

    "http://localhost:3000",   # 개발 환경에서 http도 필요할 수 있음

    # 필요한 경우 다른 프론트엔드 주소 추가

]

app.add_middleware(

    CORSMiddleware,

    allow_origins=origins,

    allow_credentials=True,

    allow_methods=["*"],  # 모든 HTTP 메서드 허용 (GET, POST 등)

    allow_headers=["*"],  # 모든 헤더 허용

)

class Item(BaseModel):

    value: List[List[str]] # 엑셀에서 받은 값 (이제 2차원 문자열 리스트를 받음)

  

@app.post("/get_chart_data")

async def process_excel_data(item: Item):

    print(f"Received value from Excel: {item.value}")

  

    # 2차원 배열인 item.value를 1차원 배열로 평탄화합니다.

    # 예: [['동양철관'], ['대동스틸']] -> ['동양철관', '대동스틸']

    flat_values = [name for sublist in item.value for name in sublist]

    print(f"Flattened values: {flat_values}")

  

    # 예: 데이터베이스 조회, 외부 API 호출 등

    processed_data = {

        "labels": ["Jan", "Feb", "Mar", "Apr", "May"],

        "values": [10 + len(item.value), 20, 15, 25, 30] # 예시 데이터, value에 따라 변경

    }

    return {"message": "Data processed successfully", "chart_data": processed_data}
```

item.value는 프론트에서 넘어온 데이터이다. 
flat_values는 평탄화가 진행된 데이터이고 이를 가지고 DB 쿼리를 진행한다.

두변수에 저장된 데이터는 다음과 같이 생겼다.
![[Pasted image 20250528104951.png]]


