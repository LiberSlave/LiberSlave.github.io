## 웹소켓

``` python
# ls_open_api.py의 fetch_realtime_news() 함수

async def fetch_realtime_news(access_token: str, news_callback: Callable):

    uri = "wss://openapi.ls-sec.co.kr:9443/websocket"
    
	# LS증권의 WebSocket 서버와 핸드셰이크(handshake)를 마치고 서버와 연결된다.
    async with websockets.connect(uri) as websocket:

        # 1. 연결 성공 로깅

        # 2. 구독 요청 메시지 전송
        
		# websocket객체를 통해 request를 한번 보낸다. 리퀘스트 전송이 완료되면 다음          코드로 넘어간다.
        await websocket.send(json.dumps(request_msg))

        # 3. 지속적으로 메시지 수신
        async for message in websocket:

            news_data = json.loads(message)

            await news_callback(news_data)
```

## 1. **프론트엔드(Web)에서 WebSocket 연결 요청**

- 사용자가 웹 대시보드(예: `LS_news.html`)를 열면,  
    JS(`LS_news.js`)에서
    
    
    
    ``` python
    new WebSocket("ws://localhost:8000/ws/news")
```
    
    로 **백엔드 FastAPI 서버**에 WebSocket 연결을 요청합니다.

---

## 2. **FastAPI 서버에서 WebSocket 연결 수락**

- [main.py](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)의
    
    ``` python
    @app.websocket("/ws/news")
    
    async def websocket_endpoint(websocket: WebSocket):
    
        await websocket.accept()
    ```
    
    
    이 엔드포인트가 호출되어 **연결을 수락**합니다.

---

## 3. **테스트 메시지 전송 (연결 확인용)**

- 서버는 우선 테스트용 뉴스 메시지를 프론트로 한 번 전송합니다.
- 이로써 프론트-백엔드 연결이 정상임을 확인합니다.

---

## 4. **LS OpenAPI 실시간 뉴스 웹소켓 연결**

- 백엔드에서
    ``` python
    await fetch_realtime_news(ACCESS_TOKEN, on_news_received)
    ```
    
    를 호출하여 **LS OpenAPI의 실시간 뉴스 서버(wss://openapi.ls-sec.co.kr:9443/websocket)** 에 별도의 웹소켓 연결을 엽니다.

---

## 5. **LS OpenAPI에 실시간 뉴스 구독 요청**

- [fetch_realtime_news](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html) 함수에서
    
    ``` python
    await websocket.send(json.dumps(request_msg))
    ```

    로 **실시간 뉴스 구독 메시지**를 LS OpenAPI에 보냅니다.

---

## 6. **LS OpenAPI에서 뉴스 데이터 수신**

- LS OpenAPI 서버에서 실시간 뉴스가 발생하면,  
    백엔드의 [async for message in websocket:](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html) 루프에서  
    **뉴스 메시지(문자열 JSON)** 를 받습니다.

---

## 7. **뉴스 데이터 파싱 및 콜백 호출**

- 받은 메시지를
    
    ``` python
    news_data = json.loads(message)
    ```
    
    로 파싱한 뒤,
    
    ``` python
    result = await news_callback(news_data)
    ```
    
    (즉, [main.py](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)의 [on_news_received](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html) 함수)로 넘깁니다.

---

## 8. **백엔드에서 뉴스 데이터 가공**

- [on_news_received(news_data)](vscode-file://vscode-app/c:/Users/%EC%86%90%EB%AF%BC%EA%B5%AC/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)에서
    - 데이터 유효성 검사
    - 종목코드 파싱 및 종목명 매핑
    - 필요시 관련 정보 추가
    - (원하면 DB/버퍼에 저장)
    - **프론트엔드로 전송 준비**

---

## 9. **프론트엔드로 뉴스 데이터 전송**

``` python
await websocket.send_json(news_data)
```
    
    로 **프론트엔드(웹 브라우저)** 에 실시간 뉴스 데이터를 전송합니다.

---

## 10. **프론트엔드에서 뉴스 수신 및 화면 표시**

- 프론트엔드 JS(WebSocket 이벤트 핸들러)에서  
    서버로부터 받은 뉴스 데이터를 받아  
    **화면에 실시간으로 표시**합니다.

---

# 요약: 전체 데이터 흐름

1. **프론트** → FastAPI WebSocket 연결 요청
2. **FastAPI** → 연결 수락, 테스트 메시지 전송
3. **FastAPI** → LS OpenAPI 실시간 뉴스 웹소켓 연결 및 구독
4. **LS OpenAPI** → 실시간 뉴스 발생 시 백엔드로 데이터 전송
5. **FastAPI** → 뉴스 데이터 파싱/가공
6. **FastAPI** → 프론트엔드로 실시간 뉴스 전송
7. **프론트** → 뉴스 수신 및 화면 표시

---

**핵심:**

- LS OpenAPI와 FastAPI는 별도의 웹소켓으로 연결
- FastAPI가 중계자 역할: LS에서 받은 뉴스를 프론트로 실시간 전달
- 필요시 백엔드에서 추가 가공/저장도 가능