

``` python
import re
from enum import Enum
from typing import Dict, List, Any, Callable, Optional

class TradingStrategy(Enum):
    SMALL_BUY = "small_buy"     # 소액 매수
    FULL_BUY = "full_buy"       # 풀 매수
    CAUTIOUS_BUY = "cautious"   # 신중한 매수
    NO_ACTION = "no_action"     # 매수하지 않음

class KeywordRule:
    def __init__(self, 
                 name: str,
                 required_keywords: List[str], 
                 optional_keywords: List[str] = None,
                 excluded_keywords: List[str] = None,
                 min_tickers: int = 1,
                 max_tickers: int = 1,
                 strategy: TradingStrategy = TradingStrategy.SMALL_BUY,
                 params: Dict[str, Any] = None):
        self.name = name
        self.required_keywords = required_keywords
        self.optional_keywords = optional_keywords or []
        self.excluded_keywords = excluded_keywords or []
        self.min_tickers = min_tickers
        self.max_tickers = max_tickers
        self.strategy = strategy
        self.params = params or {}
    
    def matches(self, title: str, tickers_count: int) -> bool:
        """제목과 종목 수가 규칙에 맞는지 확인"""
        # 1. 종목 수 확인
        if not (self.min_tickers <= tickers_count <= self.max_tickers):
            return False
            
        # 2. 필수 키워드 확인
        for keyword in self.required_keywords:
            if keyword not in title:
                return False
                
        # 3. 제외 키워드 확인
        for keyword in self.excluded_keywords:
            if keyword in title:
                return False
                
        # 4. 선택 키워드 확인 (있으면 좋지만 필수는 아님)
        # optional_keywords는 체크하지 않아도 됨
                
        return True

# 기본 제공되는 규칙들
default_rules = [
    KeywordRule(
        name="특징주 기본 매수",
        required_keywords=["[특징주]"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.SMALL_BUY,
        params={"buy_amount": 100000}  # 10만원 매수
    ),
    KeywordRule(
        name="특징주+상한가 풀매수",
        required_keywords=["[특징주]", "상한가"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.FULL_BUY,
        params={"buy_amount": 1000000}  # 100만원 매수
    ),
    KeywordRule(
        name="특징주+실적 강세",
        required_keywords=["[특징주]"],
        optional_keywords=["실적", "호실적", "어닝서프라이즈"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.CAUTIOUS_BUY,
        params={"buy_amount": 300000}  # 30만원 매수
    )
]

class TradingRuleEngine:
    def __init__(self, rules: List[KeywordRule] = None):
        self.rules = rules or default_rules
        
    def find_matching_rule(self, title: str, tickers_count: int) -> Optional[KeywordRule]:
        """제목과 종목 수에 맞는 첫 번째 규칙 반환"""
        for rule in self.rules:
            if rule.matches(title, tickers_count):
                return rule
        return None
```

``` python
from trading_rules import TradingRuleEngine, TradingStrategy

# 앱 초기화 시 규칙 엔진 생성
rule_engine = TradingRuleEngine()

# 웹소켓 처리 함수 내에서
async def on_news_received(news_data):
    # ...기존 코드...
    
    if code_str:  # 코드가 있는 경우에만 파싱
        tickers_list = parse_news_codes(code_str)
        
        # 규칙 엔진으로 매칭 규칙 찾기
        matching_rule = rule_engine.find_matching_rule(
            title=title, 
            tickers_count=len(tickers_list)
        )
        
        if matching_rule:
            ticker = tickers_list[0]
            logger.info(f"🎯 매칭된 규칙: {matching_rule.name}, 종목: {ticker}")
            
            # 전략에 따른 매개변수 설정
            trading_params = {
                "strategy": matching_rule.strategy.value,
                "amount": matching_rule.params.get("buy_amount", 100000),
                "rule_name": matching_rule.name
            }
            
            # 매매 로직 실행
            asyncio.create_task(
                news_trading_logic(
                    token=KIWOOM_ACSESS_TOKEN, 
                    news_data=news_data, 
                    ticker=ticker,
                    params=trading_params
                )
            )
```

``` python
async def news_trading_logic(token, news_data, ticker, params=None):
    """
    뉴스 기반 매매 로직
    :param token: API 접근 토큰
    :param news_data: 뉴스 데이터
    :param ticker: 종목 코드
    :param params: 매매 전략 매개변수 (선택사항)
    """
    params = params or {"strategy": "small_buy", "amount": 100000}
    
    # 매매 전략 로깅
    logger.info(f"💵 매매 전략: {params['strategy']}, 금액: {params['amount']:,}원")
    
    # 기존 코드
    stock_info = await asyncio.to_thread(get_stock_data, token, ticker)
    processed_info = stock_data_processing(stock_info)
    
    # 매수 조건 평가
    condition = buy_condition_analysis(processed_info)
    
    if condition:
        # 전략별 다른 처리
        if params["strategy"] == "full_buy":
            # 풀매수 로직
            logger.info(f"✅ 풀매수 전략 실행: {processed_info['name']}")
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        elif params["strategy"] == "cautious":
            # 신중한 매수 로직
            logger.info(f"🔍 신중한 매수 전략 실행: {processed_info['name']}")
            # 추가 조건 체크 가능
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        else:
            # 기본 소액 매수
            logger.info(f"💡 소액 매수 전략 실행: {processed_info['name']}")
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        
        # 매수 실행
        try:
            result = await asyncio.to_thread(
                buy_with_quantity, token, ticker, qty
            )
            logger.info(f"🛒 매수 시도 결과: {result}")
        except Exception as e:
            logger.error(f"🚨 매수 주문 중 오류 발생: {e}")
    else:
        logger.info(f"❌ 매수 조건 불충족: {processed_info['name']}")

def calculate_buy_quantity(price, amount):
    """매수 수량 계산"""
    return max(1, int(amount / price))
```


- 풀미수 주문 관련 (kt00011)
	https://minsuk-sung.tistory.com/36
	https://minsuk-sung.tistory.com/62



- df1/df2 제대로 반영된거 맞나? 제대로 됐다면 왜 나스닥이 1등인가? (매일 나오는 키워드일텐데)
2025-07-01
![image](/images/Pasted-image-20250701110641.png)

- df1/df2 제대로 반영된거 맞는듯
![image](/images/Pasted-image-20250702073540.png)


