

``` python
import re
from enum import Enum
from typing import Dict, List, Any, Callable, Optional

class TradingStrategy(Enum):
    SMALL_BUY = "small_buy"     # ì†Œì•¡ ë§¤ìˆ˜
    FULL_BUY = "full_buy"       # í’€ ë§¤ìˆ˜
    CAUTIOUS_BUY = "cautious"   # ì‹ ì¤‘í•œ ë§¤ìˆ˜
    NO_ACTION = "no_action"     # ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ

class KeywordRule:
    def __init__(self, 
                 name: str,
                 required_keywords: List[str], 
                 optional_keywords: List[str] = None,
                 excluded_keywords: List[str] = None,
                 min_tickers: int = 1,
                 max_tickers: int = 1,
                 strategy: TradingStrategy = TradingStrategy.SMALL_BUY,
                 params: Dict[str, Any] = None):
        self.name = name
        self.required_keywords = required_keywords
        self.optional_keywords = optional_keywords or []
        self.excluded_keywords = excluded_keywords or []
        self.min_tickers = min_tickers
        self.max_tickers = max_tickers
        self.strategy = strategy
        self.params = params or {}
    
    def matches(self, title: str, tickers_count: int) -> bool:
        """ì œëª©ê³¼ ì¢…ëª© ìˆ˜ê°€ ê·œì¹™ì— ë§ëŠ”ì§€ í™•ì¸"""
        # 1. ì¢…ëª© ìˆ˜ í™•ì¸
        if not (self.min_tickers <= tickers_count <= self.max_tickers):
            return False
            
        # 2. í•„ìˆ˜ í‚¤ì›Œë“œ í™•ì¸
        for keyword in self.required_keywords:
            if keyword not in title:
                return False
                
        # 3. ì œì™¸ í‚¤ì›Œë“œ í™•ì¸
        for keyword in self.excluded_keywords:
            if keyword in title:
                return False
                
        # 4. ì„ íƒ í‚¤ì›Œë“œ í™•ì¸ (ìˆìœ¼ë©´ ì¢‹ì§€ë§Œ í•„ìˆ˜ëŠ” ì•„ë‹˜)
        # optional_keywordsëŠ” ì²´í¬í•˜ì§€ ì•Šì•„ë„ ë¨
                
        return True

# ê¸°ë³¸ ì œê³µë˜ëŠ” ê·œì¹™ë“¤
default_rules = [
    KeywordRule(
        name="íŠ¹ì§•ì£¼ ê¸°ë³¸ ë§¤ìˆ˜",
        required_keywords=["[íŠ¹ì§•ì£¼]"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.SMALL_BUY,
        params={"buy_amount": 100000}  # 10ë§Œì› ë§¤ìˆ˜
    ),
    KeywordRule(
        name="íŠ¹ì§•ì£¼+ìƒí•œê°€ í’€ë§¤ìˆ˜",
        required_keywords=["[íŠ¹ì§•ì£¼]", "ìƒí•œê°€"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.FULL_BUY,
        params={"buy_amount": 1000000}  # 100ë§Œì› ë§¤ìˆ˜
    ),
    KeywordRule(
        name="íŠ¹ì§•ì£¼+ì‹¤ì  ê°•ì„¸",
        required_keywords=["[íŠ¹ì§•ì£¼]"],
        optional_keywords=["ì‹¤ì ", "í˜¸ì‹¤ì ", "ì–´ë‹ì„œí”„ë¼ì´ì¦ˆ"],
        min_tickers=1,
        max_tickers=1,
        strategy=TradingStrategy.CAUTIOUS_BUY,
        params={"buy_amount": 300000}  # 30ë§Œì› ë§¤ìˆ˜
    )
]

class TradingRuleEngine:
    def __init__(self, rules: List[KeywordRule] = None):
        self.rules = rules or default_rules
        
    def find_matching_rule(self, title: str, tickers_count: int) -> Optional[KeywordRule]:
        """ì œëª©ê³¼ ì¢…ëª© ìˆ˜ì— ë§ëŠ” ì²« ë²ˆì§¸ ê·œì¹™ ë°˜í™˜"""
        for rule in self.rules:
            if rule.matches(title, tickers_count):
                return rule
        return None
```

``` python
from trading_rules import TradingRuleEngine, TradingStrategy

# ì•± ì´ˆê¸°í™” ì‹œ ê·œì¹™ ì—”ì§„ ìƒì„±
rule_engine = TradingRuleEngine()

# ì›¹ì†Œì¼“ ì²˜ë¦¬ í•¨ìˆ˜ ë‚´ì—ì„œ
async def on_news_received(news_data):
    # ...ê¸°ì¡´ ì½”ë“œ...
    
    if code_str:  # ì½”ë“œê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ íŒŒì‹±
        tickers_list = parse_news_codes(code_str)
        
        # ê·œì¹™ ì—”ì§„ìœ¼ë¡œ ë§¤ì¹­ ê·œì¹™ ì°¾ê¸°
        matching_rule = rule_engine.find_matching_rule(
            title=title, 
            tickers_count=len(tickers_list)
        )
        
        if matching_rule:
            ticker = tickers_list[0]
            logger.info(f"ğŸ¯ ë§¤ì¹­ëœ ê·œì¹™: {matching_rule.name}, ì¢…ëª©: {ticker}")
            
            # ì „ëµì— ë”°ë¥¸ ë§¤ê°œë³€ìˆ˜ ì„¤ì •
            trading_params = {
                "strategy": matching_rule.strategy.value,
                "amount": matching_rule.params.get("buy_amount", 100000),
                "rule_name": matching_rule.name
            }
            
            # ë§¤ë§¤ ë¡œì§ ì‹¤í–‰
            asyncio.create_task(
                news_trading_logic(
                    token=KIWOOM_ACSESS_TOKEN, 
                    news_data=news_data, 
                    ticker=ticker,
                    params=trading_params
                )
            )
```

``` python
async def news_trading_logic(token, news_data, ticker, params=None):
    """
    ë‰´ìŠ¤ ê¸°ë°˜ ë§¤ë§¤ ë¡œì§
    :param token: API ì ‘ê·¼ í† í°
    :param news_data: ë‰´ìŠ¤ ë°ì´í„°
    :param ticker: ì¢…ëª© ì½”ë“œ
    :param params: ë§¤ë§¤ ì „ëµ ë§¤ê°œë³€ìˆ˜ (ì„ íƒì‚¬í•­)
    """
    params = params or {"strategy": "small_buy", "amount": 100000}
    
    # ë§¤ë§¤ ì „ëµ ë¡œê¹…
    logger.info(f"ğŸ’µ ë§¤ë§¤ ì „ëµ: {params['strategy']}, ê¸ˆì•¡: {params['amount']:,}ì›")
    
    # ê¸°ì¡´ ì½”ë“œ
    stock_info = await asyncio.to_thread(get_stock_data, token, ticker)
    processed_info = stock_data_processing(stock_info)
    
    # ë§¤ìˆ˜ ì¡°ê±´ í‰ê°€
    condition = buy_condition_analysis(processed_info)
    
    if condition:
        # ì „ëµë³„ ë‹¤ë¥¸ ì²˜ë¦¬
        if params["strategy"] == "full_buy":
            # í’€ë§¤ìˆ˜ ë¡œì§
            logger.info(f"âœ… í’€ë§¤ìˆ˜ ì „ëµ ì‹¤í–‰: {processed_info['name']}")
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        elif params["strategy"] == "cautious":
            # ì‹ ì¤‘í•œ ë§¤ìˆ˜ ë¡œì§
            logger.info(f"ğŸ” ì‹ ì¤‘í•œ ë§¤ìˆ˜ ì „ëµ ì‹¤í–‰: {processed_info['name']}")
            # ì¶”ê°€ ì¡°ê±´ ì²´í¬ ê°€ëŠ¥
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        else:
            # ê¸°ë³¸ ì†Œì•¡ ë§¤ìˆ˜
            logger.info(f"ğŸ’¡ ì†Œì•¡ ë§¤ìˆ˜ ì „ëµ ì‹¤í–‰: {processed_info['name']}")
            qty = calculate_buy_quantity(processed_info["current"], params["amount"])
        
        # ë§¤ìˆ˜ ì‹¤í–‰
        try:
            result = await asyncio.to_thread(
                buy_with_quantity, token, ticker, qty
            )
            logger.info(f"ğŸ›’ ë§¤ìˆ˜ ì‹œë„ ê²°ê³¼: {result}")
        except Exception as e:
            logger.error(f"ğŸš¨ ë§¤ìˆ˜ ì£¼ë¬¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    else:
        logger.info(f"âŒ ë§¤ìˆ˜ ì¡°ê±´ ë¶ˆì¶©ì¡±: {processed_info['name']}")

def calculate_buy_quantity(price, amount):
    """ë§¤ìˆ˜ ìˆ˜ëŸ‰ ê³„ì‚°"""
    return max(1, int(amount / price))
```


- í’€ë¯¸ìˆ˜ ì£¼ë¬¸ ê´€ë ¨ (kt00011)
	https://minsuk-sung.tistory.com/36
	https://minsuk-sung.tistory.com/62



- df1/df2 ì œëŒ€ë¡œ ë°˜ì˜ëœê±° ë§ë‚˜? ì œëŒ€ë¡œ ëë‹¤ë©´ ì™œ ë‚˜ìŠ¤ë‹¥ì´ 1ë“±ì¸ê°€? (ë§¤ì¼ ë‚˜ì˜¤ëŠ” í‚¤ì›Œë“œì¼í…ë°)
2025-07-01
![[Pasted image 20250701110641.png]]

- df1/df2 ì œëŒ€ë¡œ ë°˜ì˜ëœê±° ë§ëŠ”ë“¯
![[Pasted image 20250702073540.png]]

